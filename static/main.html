<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - ìˆœì°° ë¡œë´‡ ê´€ì œ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ROS Bridge Library (roslibjs) -->
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.0.1/build/roslib.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Gray-200 */
        }
        .dashboard-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1e3a8a; /* Blue-900 */
        }
        #map-canvas {
            border: 2px solid #cbd5e1; /* Slate-300 */
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-blue-200">
            <h1 class="text-4xl font-extrabold text-gray-800">
                ìˆœì°° ë¡œë´‡ ê´€ì œ ëŒ€ì‹œë³´ë“œ
            </h1>
            <div class="flex items-center space-x-4">
                <div id="ros-status" class="flex items-center space-x-2 text-sm font-semibold">
                    <span id="status-indicator" class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span id="status-text" class="text-red-700">ROS ì—°ê²° ì¤‘...</span>
                </div>
                <a href="/users" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-150">
                    ì‚¬ìš©ì ê´€ë¦¬
                </a>
                <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </header>

        <!-- ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ -->
        <div class="grid grid-cols-12 gap-8">
            
            <!-- ì™¼ìª½ ì„¹ì…˜: ì§€ë„ ë° ë¹„ë””ì˜¤ (col-span-8) -->
            <div class="col-span-12 lg:col-span-8 space-y-8">
                
                <!-- 1. SLAM ì§€ë„ ë° ë¡œë´‡ ìœ„ì¹˜ -->
                <div class="dashboard-card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">SLAM ìˆœì°° ì§€ë„ ë° ì‹¤ì‹œê°„ ìœ„ì¹˜</h2>
                    <div id="map-container" class="relative w-full aspect-video bg-gray-100 flex items-center justify-center rounded-lg overflow-hidden">
                        <!-- ì‹¤ì œ ë§µ ìº”ë²„ìŠ¤ ì˜ì—­. ros2djs ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•¨. -->
                        <canvas id="map-canvas" width="700" height="500" class="w-full h-full object-cover rounded-lg"></canvas>
                        <p id="map-placeholder" class="absolute text-gray-500 text-center p-4">
                            ROS Bridge ì—°ê²° í›„ ì§€ë„ í† í”½(/map)ì„ êµ¬ë…í•˜ì—¬ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. <br>
                            ë¡œë´‡ ìœ„ì¹˜ëŠ” (/robot_pose) í† í”½ì„ í†µí•´ ì§€ë„ ìœ„ì— ì˜¤ë²„ë ˆì´ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div id="robot-location" class="mt-4 text-gray-600 font-medium">
                        í˜„ì¬ ë¡œë´‡ ì¢Œí‘œ: N/A
                    </div>
                </div>

                <!-- 2. ì‹¤ì‹œê°„ ì›¹ìº  ë³´ê¸° -->
                <div class="dashboard-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">ì‹¤ì‹œê°„ ìƒí™© ë³´ê¸° (ì›¹ìº )</h2>
                        <button id="video-toggle-btn" onclick="toggleVideo()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            ì˜ìƒ ì‹œì‘
                        </button>
                    </div>
                    <div id="video-container" class="w-full aspect-video bg-gray-800 flex items-center justify-center rounded-lg hidden">
                        <!-- MJPEG ìŠ¤íŠ¸ë¦¬ë° URLì„ ì—¬ê¸°ì— ì„¤ì •í•©ë‹ˆë‹¤. -->
                        <img id="webcam-feed" alt="ì‹¤ì‹œê°„ ì›¹ìº  í”¼ë“œ" class="w-full h-full object-cover">
                        <p id="video-placeholder" class="text-white text-lg">ì›¹ìº  ìŠ¤íŠ¸ë¦¬ë° ì¤€ë¹„ ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜: ë¡œë´‡ ìƒíƒœê°’ (col-span-4) -->
            <div class="col-span-12 lg:col-span-4 space-y-6">
                <div class="dashboard-card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">ë¡œë´‡ ì‹¤ì‹œê°„ ìƒíƒœ</h2>
                    
                    <!-- ìƒíƒœ ë©”íŠ¸ë¦­ ì¹´ë“œ: ë°°í„°ë¦¬ -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <p class="text-sm text-blue-600 font-medium">ì‹¤ì‹œê°„ ë°°í„°ë¦¬ ì”ëŸ‰</p>
                        <div class="flex justify-between items-center mt-1">
                            <span id="metric-battery" class="metric-value">--%</span>
                            <svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 002 0V7a1 1 0 10-2 0v3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>

                    <!-- ìƒíƒœ ë©”íŠ¸ë¦­ ì¹´ë“œ: ìˆœì°° ê±°ë¦¬ -->
                    <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                        <p class="text-sm text-indigo-600 font-medium">ìˆœì°° ê±°ë¦¬ (ëˆ„ì )</p>
                        <div class="flex justify-between items-center mt-1">
                            <span id="metric-distance" class="metric-value">-- m</span>
                            <svg class="w-10 h-10 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>

                    <!-- ìƒíƒœ ë©”íŠ¸ë¦­ ì¹´ë“œ: ìˆœì°° ì‹œê°„ -->
                    <div class="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
                        <p class="text-sm text-purple-600 font-medium">ìˆœì°° ì‹œê°„</p>
                        <div class="flex justify-between items-center mt-1">
                            <span id="metric-time" class="metric-value">-- min</span>
                            <svg class="w-10 h-10 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- ë¡œë´‡ ì œì–´ ì˜ì—­ (ì„ íƒ ì‚¬í•­) -->
                <div class="dashboard-card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">ë¡œë´‡ ì œì–´</h2>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="publishCommand('forward')" class="col-span-3 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-lg">ì „ì§„</button>
                        <button onclick="publishCommand('left')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">ì¢ŒíšŒì „</button>
                        <button onclick="publishCommand('stop')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">ì •ì§€</button>
                        <button onclick="publishCommand('right')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">ìš°íšŒì „</button>
                        <button onclick="publishCommand('backward')" class="col-span-3 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-lg">í›„ì§„</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // 1. ROS Bridge ì„¤ì •
        // ====================================================================
        
        // ğŸš¨ ì¤‘ìš”: ë¡œë´‡ì˜ ROS Bridge ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        const ROSBRIDGE_SERVER_IP = '192.168.0.100'; // ì˜ˆì‹œ IP
        const ROSBRIDGE_PORT = 9090;
        
        const ros = new ROSLIB.Ros({
            url: `ws://${ROSBRIDGE_SERVER_IP}:${ROSBRIDGE_PORT}`
        });

        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        ros.on('connection', () => {
            console.log('ROS Bridgeì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            statusIndicator.classList.remove('bg-red-500', 'bg-yellow-500');
            statusIndicator.classList.add('bg-green-500');
            statusText.textContent = 'ROS ì—°ê²°ë¨';
            statusText.classList.remove('text-red-700', 'text-yellow-700');
            statusText.classList.add('text-green-700');
            
            // ì—°ê²° ì„±ê³µ ì‹œ í† í”½ êµ¬ë… ì‹œì‘
            subscribeToTopics();
        });

        ros.on('error', (error) => {
            console.error('ROS Bridge ì—°ê²° ì˜¤ë¥˜:', error);
            statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
            statusIndicator.classList.add('bg-red-500');
            statusText.textContent = 'ROS ì˜¤ë¥˜ ë°œìƒ';
            statusText.classList.remove('text-green-700', 'text-yellow-700');
            statusText.classList.add('text-red-700');
        });

        ros.on('close', () => {
            console.log('ROS Bridge ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„ ì¤‘...');
            statusIndicator.classList.remove('bg-green-500', 'bg-red-500');
            statusIndicator.classList.add('bg-yellow-500');
            statusText.textContent = 'ROS ì—°ê²° ëŠê¹€';
            statusText.classList.remove('text-green-700', 'text-red-700');
            statusText.classList.add('text-yellow-700');
            
            // ì¼ì • ì‹œê°„ í›„ ì¬ì—°ê²° ì‹œë„
            setTimeout(() => {
                ros.connect(`ws://${ROSBRIDGE_SERVER_IP}:${ROSBRIDGE_PORT}`);
            }, 3000);
        });

        // ====================================================================
        // 2. í† í”½ êµ¬ë…
        // ====================================================================
        function subscribeToTopics() {
            // 2.1. ë¡œë´‡ ìœ„ì¹˜ (Odometry ë˜ëŠ” Pose)
            const poseListener = new ROSLIB.Topic({
                ros: ros,
                name: '/robot_pose', // ğŸš¨ ì‹¤ì œ ë¡œë´‡ì˜ ìœ„ì¹˜ í† í”½ìœ¼ë¡œ ë³€ê²½
                messageType: 'geometry_msgs/PoseStamped' // ğŸš¨ ì‹¤ì œ í† í”½ ë©”ì‹œì§€ íƒ€ì…ìœ¼ë¡œ ë³€ê²½
            });

            poseListener.subscribe((message) => {
                const x = message.pose.position.x.toFixed(2);
                const y = message.pose.position.y.toFixed(2);
                // ì§€ë„ì— ì‹¤ì œ ìœ„ì¹˜ë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ì´ ì—¬ê¸°ì— ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤. (ë³µì¡í•˜ë¯€ë¡œ í…ìŠ¤íŠ¸ë¡œë§Œ í‘œì‹œ)
                document.getElementById('robot-location').textContent = `í˜„ì¬ ë¡œë´‡ ì¢Œí‘œ: X=${x} m, Y=${y} m`;
            });

            // 2.2. ë¡œë´‡ ìƒíƒœ ë©”íŠ¸ë¦­ (ë°°í„°ë¦¬, ê±°ë¦¬, ì‹œê°„)
            const metricsListener = new ROSLIB.Topic({
                ros: ros,
                name: '/robot_metrics', // ğŸš¨ ì‹¤ì œ ë¡œë´‡ ìƒíƒœ í† í”½ìœ¼ë¡œ ë³€ê²½ (Custom Messageë¥¼ ê°€ì •)
                messageType: 'std_msgs/String' // ì„ì‹œë¡œ String ë©”ì‹œì§€ë¥¼ ê°€ì •
            });

            metricsListener.subscribe((message) => {
                // ì‹¤ì œ ROS í™˜ê²½ì—ì„œëŠ” JSON ë˜ëŠ” Custom Messageë¥¼ íŒŒì‹±í•´ì•¼ í•¨
                // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œ ë”ë¯¸ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                try {
                    // const metrics = JSON.parse(message.data); 
                    // document.getElementById('metric-battery').textContent = `${metrics.battery_level.toFixed(0)}%`;
                    // document.getElementById('metric-distance').textContent = `${metrics.patrol_distance.toFixed(1)} m`;
                    // document.getElementById('metric-time').textContent = `${(metrics.patrol_time / 60).toFixed(0)} min`;
                    
                    // ë”ë¯¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì˜ˆì‹œ)
                    let currentBattery = parseInt(document.getElementById('metric-battery').textContent.replace('%', '')) || 95;
                    currentBattery = (currentBattery > 70) ? currentBattery - 1 : 95;
                    document.getElementById('metric-battery').textContent = `${currentBattery}%`;

                    let currentDistance = parseFloat(document.getElementById('metric-distance').textContent.replace(' m', '')) || 15.0;
                    currentDistance = currentDistance + 0.1;
                    document.getElementById('metric-distance').textContent = `${currentDistance.toFixed(1)} m`;

                    let currentTime = parseInt(document.getElementById('metric-time').textContent.replace(' min', '')) || 120;
                    currentTime = currentTime + 1;
                    document.getElementById('metric-time').textContent = `${currentTime} min`;
                } catch (e) {
                    console.error("Metrics ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", e);
                }
            });
            
            // 2.3. SLAM Map (nav_msgs/OccupancyGrid) êµ¬ë…ì€ ë³µì¡í•˜ë¯€ë¡œ, 
            // ros2djs ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ëŠ” ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ì–´ë µìŠµë‹ˆë‹¤.
            // UIì— ìº”ë²„ìŠ¤ë§Œ ì¤€ë¹„í•´ ë‘¡ë‹ˆë‹¤.
            console.log("ì§€ë„ í† í”½(/map) êµ¬ë… ì¤€ë¹„ ì™„ë£Œ. ì‹¤ì œ ë Œë”ë§ì€ ros2djs ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        }


        // ====================================================================
        // 3. ì›¹ìº  ìŠ¤íŠ¸ë¦¬ë° ì œì–´
        // ====================================================================
        
        // ğŸš¨ ì¤‘ìš”: MJPEG ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì‹¤í–‰ ì¤‘ì¸ ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        const MJPEG_STREAM_URL = `http://${ROSBRIDGE_SERVER_IP}:8080/stream?topic=/camera/image_raw`; 

        const videoContainer = document.getElementById('video-container');
        const webcamFeed = document.getElementById('webcam-feed');
        const videoToggleBtn = document.getElementById('video-toggle-btn');
        let isVideoRunning = false;

        function toggleVideo() {
            if (!isVideoRunning) {
                // ì˜ìƒ ì‹œì‘
                videoContainer.classList.remove('hidden');
                webcamFeed.src = MJPEG_STREAM_URL;
                videoToggleBtn.textContent = 'ì˜ìƒ ì¤‘ì§€';
                videoToggleBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                videoToggleBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                isVideoRunning = true;
            } else {
                // ì˜ìƒ ì¤‘ì§€
                webcamFeed.src = ''; // ì´ë¯¸ì§€ ì†ŒìŠ¤ë¥¼ ë¹„ì›Œ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì§€
                videoContainer.classList.add('hidden');
                videoToggleBtn.textContent = 'ì‹¤ì‹œê°„ìƒí™©ë³´ê¸°';
                videoToggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                videoToggleBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                isVideoRunning = false;
            }
        }


        // ====================================================================
        // 4. ë¡œë´‡ ìˆ˜ë™ ì œì–´ (Twist ëª…ë ¹ ë°œí–‰)
        // ====================================================================
        
        const cmdVel = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel', // ğŸš¨ ì‹¤ì œ ë¡œë´‡ì˜ ì†ë„ ëª…ë ¹ í† í”½ìœ¼ë¡œ ë³€ê²½
            messageType: 'geometry_msgs/Twist'
        });

        function publishCommand(command) {
            if (!ros.isConnected) {
                console.warn('ROS Bridgeì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ëª…ë ¹ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì»¤ìŠ¤í…€ ëª¨ë‹¬ ì‚¬ìš© ê¶Œì¥)
                alert('ROS ì„œë²„ì— ì—°ê²°ë˜ì–´ì•¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            let linear = { x: 0.0, y: 0.0, z: 0.0 };
            let angular = { x: 0.0, y: 0.0, z: 0.0 };
            const speed = 0.5; // ì„ í˜• ì†ë„ (m/s)
            const turn = 0.5;  // ê°ì†ë„ (rad/s)

            switch (command) {
                case 'forward': linear.x = speed; break;
                case 'backward': linear.x = -speed; break;
                case 'left': angular.z = turn; break;
                case 'right': angular.z = -turn; break;
                case 'stop': break; // ëª¨ë“  ê°’ì´ 0ìœ¼ë¡œ ìœ ì§€

                default: return;
            }

            const twist = new ROSLIB.Message({
                linear: linear,
                angular: angular
            });

            cmdVel.publish(twist);
            console.log(`Command published: ${command}`);
        }
        
        // ====================================================================
        // 5. ì´ˆê¸°í™”
        // ====================================================================

        window.onload = function() {
            // ë¡œë´‡ì˜ ROS Bridgeì— ì—°ê²° ì‹œë„
            ros.connect();
        };

        // ê²½ê³ : alert() ëŒ€ì‹  ì»¤ìŠ¤í…€ ëª¨ë‹¬ UIë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ, 
        // í¸ì˜ìƒ ì´ ì˜ˆì‹œì—ì„œëŠ” alert()ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” êµì²´í•´ì£¼ì„¸ìš”.
        function alert(message) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                                        <p class="text-lg font-bold text-red-600 mb-4">ê²½ê³ </p>
                                        <p class="text-gray-700 mb-6">${message}</p>
                                        <button onclick="this.closest('.fixed').remove()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-full">í™•ì¸</button>
                                    </div>
                                </div>`;
            document.body.appendChild(tempDiv);
        }
    </script>
</body>
</html>
